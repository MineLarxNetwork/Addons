name: Build Addons

on:
  push:
    paths:
      - '**/version.txt'
      - '**/*.tga'
      - '**/*.json'
      - '**/*.png'
      - '**/*.lang'
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install zip
        run: sudo apt-get install -y zip

      - name: Get changed directories
        id: changed-dirs
        run: |
          CHANGED_DIRS=$(git diff --name-only HEAD^ HEAD | grep '/' | cut -d'/' -f1 | sort -u)
          echo "dirs=$CHANGED_DIRS" >> $GITHUB_OUTPUT

      - name: Build and package addons
        if: steps.changed-dirs.outputs.dirs != ''
        run: |
          # 将输出转换为数组
          mapfile -t DIRS < <(echo "${{ steps.changed-dirs.outputs.dirs }}")
          
          # 遍历每个目录
          for dir in "${DIRS[@]}"; do
            if [ -d "$dir" ] && [ -f "$dir/version.txt" ]; then
              # 读取版本号并去除空白字符
              VERSION=$(tr -d '[:space:]' < "$dir/version.txt")
              
              # 创建输出目录
              mkdir -p artifacts
              
              # 打包文件夹内容
              cd "$dir" || exit 1
              zip -r "../artifacts/${dir}_${VERSION}.mcaddon" .
              cd .. || exit 1
            fi
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: steps.changed-dirs.outputs.dirs != ''
        with:
          name: Addons
          path: artifacts/*.mcaddon
          retention-days: 30
